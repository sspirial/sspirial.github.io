{{- /* File-based Comments System */ -}}
<div id="comments" class="comments-area">
  <h3 class="comments-title">Comments</h3>
  
  {{- /* Display existing comments from data files */ -}}
  {{- $postSlug := .File.ContentBaseName -}}
  {{- $commentsPath := printf "comments/%s" $postSlug -}}
  {{- $comments := index .Site.Data.comments $postSlug -}}
  
  {{- if $comments -}}
  <div class="comments-list">
    {{- range $comments -}}
    <div class="comment">
      <div class="comment-header">
        <strong class="comment-author">{{ .name }}</strong>
        <time class="comment-date">{{ .date }}</time>
      </div>
      <div class="comment-body">
        {{ .message | markdownify }}
      </div>
    </div>
    {{- end -}}
  </div>
  {{- else -}}
  <p class="no-comments">No comments yet. Be the first to comment!</p>
  {{- end -}}

  {{- /* Comment submission form */ -}}
  <div class="comment-form-wrapper">
    <h4>Leave a Comment</h4>
    <form id="comment-form" class="comment-form" method="POST">
      <input type="hidden" name="post_slug" value="{{ $postSlug }}">
      <input type="hidden" name="post_title" value="{{ .Title }}">
      
      <div class="form-group">
        <label for="comment-name">Name <span class="required">*</span></label>
        <input type="text" id="comment-name" name="name" required maxlength="100">
      </div>
      
      <div class="form-group">
        <label for="comment-email">Email (optional, not published)</label>
        <input type="email" id="comment-email" name="email" maxlength="100">
      </div>
      
      <div class="form-group">
        <label for="comment-message">Comment <span class="required">*</span></label>
        <textarea id="comment-message" name="message" required rows="5" maxlength="5000"></textarea>
      </div>
      
      <div class="form-group">
        <button type="submit" id="comment-submit" class="comment-submit-btn">Submit Comment</button>
        <span id="comment-status" class="comment-status"></span>
      </div>
      
      <p class="form-note">
        Comments are moderated and will appear after approval. 
        You can use Markdown in your comment.
      </p>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('comment-form');
  const submitBtn = document.getElementById('comment-submit');
  const status = document.getElementById('comment-status');
  
  if (form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      status.textContent = '';
      
      try {
        const formData = new FormData(form);
        const slug = formData.get('post_slug');
        const name = formData.get('name');
        const email = formData.get('email') || '';
        const message = formData.get('message');
        
        // Submit to Vercel serverless function
        const response = await fetch('/api/submit-comment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            slug: slug,
            name: name,
            email: email,
            message: message
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          status.textContent = '✓ Comment submitted successfully! It will appear after moderation.';
          status.className = 'comment-status success';
          form.reset();
        } else {
          throw new Error(data.message || 'Submission failed');
        }
      } catch (error) {
        status.textContent = '✗ Error submitting comment. Please try again later.';
        status.className = 'comment-status error';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Comment';
      }
    });
  }
});
</script>
