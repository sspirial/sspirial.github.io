{{- /* File-based Comments System */ -}}
<div id="comments" class="comments-area">
  <h3 class="comments-title">Comments</h3>
  
  {{- /* Display existing comments from data files */ -}}
  {{- $postSlug := .File.ContentBaseName -}}
  {{- $commentsPath := printf "comments/%s" $postSlug -}}
  {{- $comments := index .Site.Data.comments $postSlug -}}
  
  {{- if $comments -}}
  <div class="comments-list">
    {{- range $comments -}}
    <div class="comment">
      <div class="comment-header">
        <strong class="comment-author">{{ .name }}</strong>
        <time class="comment-date">{{ .date }}</time>
      </div>
      <div class="comment-body">
        {{ .message | markdownify }}
      </div>
    </div>
    {{- end -}}
  </div>
  {{- else -}}
  <p class="no-comments">No comments yet. Be the first to comment!</p>
  {{- end -}}

  {{- /* Comment submission form */ -}}
  <div class="comment-form-wrapper">
    <h4>Leave a Comment</h4>
    <form id="comment-form" class="comment-form" method="POST">
      <input type="hidden" name="post_slug" value="{{ $postSlug }}">
      <input type="hidden" name="post_url" value="{{ .Permalink }}">
      <input type="hidden" name="post_title" value="{{ .Title }}">
      
      <div class="form-group">
        <label for="comment-name">Name <span class="required">*</span></label>
        <input type="text" id="comment-name" name="name" required maxlength="100">
      </div>
      
      <div class="form-group">
        <label for="comment-email">Email (optional, not published)</label>
        <input type="email" id="comment-email" name="email" maxlength="100">
      </div>
      
      <div class="form-group">
        <label for="comment-message">Comment <span class="required">*</span></label>
        <textarea id="comment-message" name="message" required rows="5" maxlength="5000"></textarea>
      </div>
      
      <div class="form-group">
        <button type="submit" id="comment-submit" class="comment-submit-btn">Submit Comment</button>
        <span id="comment-status" class="comment-status"></span>
      </div>
      
      <p class="form-note">
        Comments are moderated and will appear after approval. 
        You can use Markdown in your comment.
      </p>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('comment-form');
  const submitBtn = document.getElementById('comment-submit');
  const status = document.getElementById('comment-status');
  
  if (form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      status.textContent = '';
      
      try {
        const formData = new FormData(form);
        const slug = formData.get('post_slug');
        const name = formData.get('name');
        const email = formData.get('email') || '';
        const message = formData.get('message');
        const date = new Date().toISOString();
        
        // Create YAML content for the comment
        const yamlContent = `name: "${name}"
email: "${email}"
date: "${date}"
message: |
  ${message.split('\n').map(line => '  ' + line).join('\n')}`;
        
        // Create issue body with comment data
        const issueBody = `**New Comment Submission**

üìù **Post:** ${slug}
üë§ **Name:** ${name}
üìß **Email:** ${email || 'Not provided'}
üìÖ **Date:** ${date}

---

### Comment:
${message}

---

### To Approve This Comment:

The GitHub Action will automatically create a PR with this comment file. Just merge the PR to publish the comment.

<details>
<summary>Comment Data (for manual approval if needed)</summary>

\`\`\`yaml
# Save as: data/comments/${slug}/comment-${Date.now()}.yml
${yamlContent}
\`\`\`

</details>`;

        // Create GitHub issue (no auth required for public repos)
        const response = await fetch('https://api.github.com/repos/sspirial/sspirial.github.io/issues', {
          method: 'POST',
          headers: {
            'Accept': 'application/vnd.github+json',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            title: `Comment: ${name} on "${slug}"`,
            body: issueBody,
            labels: ['comment', 'pending-review']
          })
        });
        
        if (response.ok) {
          status.textContent = '‚úì Comment submitted successfully! It will appear after moderation.';
          status.className = 'comment-status success';
          form.reset();
        } else {
          throw new Error('Submission failed');
        }
      } catch (error) {
        status.textContent = '‚úó Error submitting comment. Please try again later.';
        status.className = 'comment-status error';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Comment';
      }
    });
  }
});
</script>
